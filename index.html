<!--
  GCP CREDENTIALS & ONBOARDING GUIDE:

  1. Google Cloud Console → APIs & Services → OAuth consent screen
     - Under "Test users", add your Google account email(s) that will use this app.
     - Save and wait a few minutes for propagation.
  2. Under "Authorized domains", add:
     • example.com (if using custom domain) or localhost (for local testing)
  3. Go to APIs & Services → Credentials
     - Edit your OAuth client ID (Web application):
       Authorized JavaScript origins:
         • http://localhost:8000
         • https://googleplay-login.vercel.app
     - Save changes.
  4. If your app is ready for public use, in the OAuth consent screen settings, click "Publish App" to move from Testing to Production.
     - This removes the test-user restriction.

  5. Enable APIs:
     • Play Android Developer API
     • Google Identity Services API

  6. Copy your OAuth Client ID here:
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="script-src 'self' https://accounts.google.com https://apis.google.com https://www.gstatic.com 'unsafe-inline';">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Play Store Reviews Manager</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    label, input, button { display: block; margin: 8px 0; }
    input, button { padding: 8px; font-size: 1rem; }
    button { cursor: pointer; }
    .reviews-container { margin-top: 20px; max-height: 400px; overflow-y: auto; background: #f9f9f9; padding: 10px; }
    .review { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .log { background: #eef; padding: 8px; margin: 8px 0; font-family: monospace; }
  </style>
</head>
<body>
  <h2>Play Store Reviews Manager</h2>
  <div id="logContainer" class="log"></div>

  <section id="config">
    <label for="clientId">OAuth Client ID</label>
    <input type="text" id="clientId" placeholder="Your Client ID">
    <button id="init">Initialize</button>
  </section>

  <section id="auth" class="hidden">
    <button id="signIn">Sign In & Authorize</button>
    <button id="signOut" class="hidden">Sign Out</button>
    <div id="userInfo" class="hidden"></div>
  </section>

  <section id="app" class="hidden">
    <label for="pkg">App Package Name</label>
    <input type="text" id="pkg" placeholder="com.example.app">
    <button id="fetch">Fetch Reviews</button>
  </section>

  <div id="reviews" class="reviews-container hidden"></div>

  <script>
    (function() {
      // Utility log
      const logContainer = document.getElementById('logContainer');
      function log(msg) {
        console.log(msg);
        const el = document.createElement('div'); el.textContent = msg; logContainer.appendChild(el);
      }

      let clientId = '';
      const SCOPES = 'https://www.googleapis.com/auth/androidpublisher';
      let tokenClient;
      let accessToken = '';

      // Cache DOM elements
      const el = {
        config: document.getElementById('config'),
        auth: document.getElementById('auth'),
        app: document.getElementById('app'),
        reviews: document.getElementById('reviews'),
        clientIdInput: document.getElementById('clientId'),
        initBtn: document.getElementById('init'),
        signInBtn: document.getElementById('signIn'),
        signOutBtn: document.getElementById('signOut'),
        userInfo: document.getElementById('userInfo'),
        pkgInput: document.getElementById('pkg'),
        fetchBtn: document.getElementById('fetch')
      };

      // Initialize token client
      el.initBtn.addEventListener('click', () => {
        clientId = el.clientIdInput.value.trim();
        if (!clientId) { log('Initialization failed: Client ID missing'); return alert('Please enter Client ID'); }
        log('Initializing Google Identity Services with Client ID: ' + clientId);
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: SCOPES,
          callback: handleTokenResponse
        });
        toggle(el.config, false);
        toggle(el.auth, true);
        log('Token client initialized');
      });

      // Sign in
      el.signInBtn.addEventListener('click', () => {
        log('Requesting access token (prompt=consent)');
        tokenClient.requestAccessToken({prompt: 'consent'});
      });

      // Sign out
      el.signOutBtn.addEventListener('click', () => {
        log('Revoking token');
        google.accounts.oauth2.revoke(accessToken, () => {
          accessToken = '';
          updateUI(false);
          log('Token revoked');
        });
      });

      // Fetch reviews
      el.fetchBtn.addEventListener('click', () => {
        const pkg = el.pkgInput.value.trim();
        if (!pkg) { log('Fetch aborted: Package name missing'); return alert('Enter package name'); }
        if (!accessToken) { log('Fetch aborted: Not signed in'); return alert('Please sign in first'); }
        log('Fetching reviews for package: ' + pkg);
        fetchReviews(pkg);
      });

      // Handle token response
      function handleTokenResponse(resp) {
        log('Token response received: ' + JSON.stringify(resp));
        if (resp.error) {
          console.error(resp);
          log('Token error: ' + resp.error);
          return alert('Token error: ' + resp.error);
        }
        accessToken = resp.access_token;
        updateUI(true);
        log('Access token set');
      }

      // Toggle element visibility
      function toggle(element, show) {
        element.classList.toggle('hidden', !show);
      }

      // Update UI on sign in/out
      function updateUI(signedIn) {
        log('Updating UI, signedIn=' + signedIn);
        toggle(el.signInBtn, !signedIn);
        toggle(el.signOutBtn, signedIn);
        toggle(el.userInfo, signedIn);
        toggle(el.app, signedIn);
        el.reviews.classList.add('hidden');
        if (signedIn) {
          el.userInfo.textContent = 'Authorized';
          toggle(el.userInfo, true);
        }
      }

      // Fetch and render reviews
      async function fetchReviews(pkg) {
        el.reviews.textContent = 'Loading...';
        toggle(el.reviews, true);
        try {
          const url = `https://androidpublisher.googleapis.com/androidpublisher/v3/applications/${encodeURIComponent(pkg)}/reviews`;
          log('Calling API: ' + url);
          const res = await fetch(url, { headers: { Authorization: 'Bearer ' + accessToken } });
          log('API response status: ' + res.status);
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          log('Fetched reviews count: ' + (data.reviews || []).length);
          renderReviews(data.reviews || []);
        } catch (e) {
          log('Error fetching reviews: ' + e.message);
          el.reviews.textContent = 'Error: ' + e.message;
        }
      }

      // Render reviews list
      function renderReviews(reviews) {
        el.reviews.innerHTML = reviews.map(r => {
          const c = r.comments[0].userComment;
          return `<div class="review"><strong>${c.authorName}</strong> (Rating: ${c.starRating})<br>${c.text}</div>`;
        }).join('');
        log('Rendered reviews');
      }

    })();
  </script>
</body>
</html>
