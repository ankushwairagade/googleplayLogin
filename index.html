<!--
  GCP CREDENTIALS & MIGRATION:
  1. Google Cloud Console → APIs & Services → Credentials
  2. Enable Play Android Developer API & Identity Services API
  3. OAuth Consent Screen: configure external/internal, add your domains
  4. Create OAuth client ID (Web app)
     - Authorized JS origins:
         • http://localhost:8000
         • https://your-app.vercel.app
     - Save client ID here
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="script-src 'self' https://accounts.google.com https://apis.google.com https://www.gstatic.com 'unsafe-inline';">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Play Store Reviews Manager</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    label, input, button { display: block; margin: 8px 0; }
    input, button { padding: 8px; font-size: 1rem; }
    button { cursor: pointer; }
    .reviews-container { margin-top: 20px; max-height: 400px; overflow-y: auto; background: #f9f9f9; padding: 10px; }
    .review { border-bottom: 1px solid #ddd; padding: 10px 0; }
  </style>
</head>
<body>
  <h2>Play Store Reviews Manager</h2>

  <section id="config">
    <label for="clientId">OAuth Client ID</label>
    <input type="text" id="clientId" placeholder="Your Client ID">
    <button id="init">Initialize</button>
  </section>

  <section id="auth" class="hidden">
    <button id="signIn">Sign In & Authorize</button>
    <button id="signOut" class="hidden">Sign Out</button>
    <div id="userInfo" class="hidden"></div>
  </section>

  <section id="app" class="hidden">
    <label for="pkg">App Package Name</label>
    <input type="text" id="pkg" placeholder="com.example.app">
    <button id="fetch">Fetch Reviews</button>
  </section>

  <div id="reviews" class="reviews-container hidden"></div>

  <script>
    (function() {
      let clientId = '';
      const SCOPES = 'https://www.googleapis.com/auth/androidpublisher';
      let tokenClient;
      let accessToken = '';

      // Cache DOM elements
      const el = {
        config: document.getElementById('config'),
        auth: document.getElementById('auth'),
        app: document.getElementById('app'),
        reviews: document.getElementById('reviews'),
        clientIdInput: document.getElementById('clientId'),
        initBtn: document.getElementById('init'),
        signInBtn: document.getElementById('signIn'),
        signOutBtn: document.getElementById('signOut'),
        userInfo: document.getElementById('userInfo'),
        pkgInput: document.getElementById('pkg'),
        fetchBtn: document.getElementById('fetch')
      };

      // Initialize token client
      el.initBtn.addEventListener('click', () => {
        clientId = el.clientIdInput.value.trim();
        if (!clientId) return alert('Please enter Client ID');
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: SCOPES,
          callback: handleTokenResponse
        });
        toggle(el.config, false);
        toggle(el.auth, true);
      });

      // Sign in
      el.signInBtn.addEventListener('click', () => {
        tokenClient.requestAccessToken({prompt: 'consent'});
      });

      // Sign out
      el.signOutBtn.addEventListener('click', () => {
        google.accounts.oauth2.revoke(accessToken, () => {
          accessToken = '';
          updateUI(false);
        });
      });

      // Fetch reviews
      el.fetchBtn.addEventListener('click', () => {
        const pkg = el.pkgInput.value.trim();
        if (!pkg) return alert('Enter package name');
        if (!accessToken) return alert('Please sign in first');
        fetchReviews(pkg);
      });

      // Handle token response
      function handleTokenResponse(resp) {
        if (resp.error) {
          console.error(resp);
          return alert('Token error: ' + resp.error);
        }
        accessToken = resp.access_token;
        updateUI(true);
      }

      // Toggle element visibility
      function toggle(element, show) {
        element.classList.toggle('hidden', !show);
      }

      // Update UI on sign in/out
      function updateUI(signedIn) {
        toggle(el.signInBtn, !signedIn);
        toggle(el.signOutBtn, signedIn);
        toggle(el.userInfo, signedIn);
        toggle(el.app, signedIn);
        el.reviews.classList.add('hidden');
        if (signedIn) {
          el.userInfo.textContent = 'Authorized';
          toggle(el.userInfo, true);
        }
      }

      // Fetch and render reviews
      async function fetchReviews(pkg) {
        el.reviews.textContent = 'Loading...';
        toggle(el.reviews, true);
        try {
          const url = `https://androidpublisher.googleapis.com/androidpublisher/v3/applications/${encodeURIComponent(pkg)}/reviews`;
          const res = await fetch(url, {
            headers: { Authorization: 'Bearer ' + accessToken }
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          renderReviews(data.reviews || []);
        } catch (e) {
          el.reviews.textContent = 'Error: ' + e.message;
        }
      }

      // Render reviews list
      function renderReviews(reviews) {
        el.reviews.innerHTML = reviews.map(r => {
          const c = r.comments[0].userComment;
          return `
            <div class="review">
              <strong>${c.authorName}</strong> (Rating: ${c.starRating})<br>
              ${c.text}
            </div>`;
        }).join('');
      }

    })();
  </script>
</body>
</html>
