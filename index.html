<!--
  STEP-BY-STEP GUIDE TO FIX ORIGIN AND CSP ERRORS:
  1. In Google Cloud Console, whitelist your origins:
     - http://localhost:8000
     - https://googleplay-login.vercel.app
  2. Serve over HTTP(S), not file:// (e.g., `python3 -m http.server 8000`).
  3. Add/adjust your Content Security Policy to allow external Google scripts.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://accounts.google.com https://www.gstatic.com 'unsafe-inline' 'unsafe-eval' blob: data:;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Play Store Reviews Manager</title>
  <!-- Load the Google APIs client library -->
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    input, button, textarea { padding: 8px; font-size: 1rem; margin: 4px 0; }
    button { cursor: pointer; }
    .review { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .reviews-container { max-height: 400px; overflow-y: auto; background: #f9f9f9; padding: 10px; }
  </style>
</head>
<body>
  <h2>Google Play Store Reviews Manager</h2>

  <!-- Prompt for Client ID -->
  <div id="config-section">
    <label for="clientId">OAuth Client ID:</label><br>
    <input type="text" id="clientId" placeholder="Enter your Client ID here" style="width: 400px;"><br>
    <button id="initBtn">Initialize Google API</button>
  </div>

  <div id="auth-section" class="hidden">
    <button id="signin-btn">Sign In with Google</button>
    <button id="signout-btn" class="hidden">Sign Out</button>
    <div id="auth-info" class="hidden"></div>
  </div>

  <div id="app-section" class="hidden">
    <label for="pkg">Package Name:</label><br>
    <input type="text" id="pkg" placeholder="e.g., com.example.myapp" style="width: 300px;"><br>
    <button id="fetchBtn">Fetch Reviews</button>
  </div>

  <div id="reviews" class="reviews-container hidden"></div>

  <script>
    let CLIENT_ID = '';
    const API_DISCOVERY_DOC = 'https://androidpublisher.googleapis.com/$discovery/rest?version=v3';
    const SCOPES = 'https://www.googleapis.com/auth/androidpublisher';
    let GoogleAuth;

    document.getElementById('initBtn').onclick = () => {
      CLIENT_ID = document.getElementById('clientId').value.trim();
      if (!CLIENT_ID) return alert('Please enter your OAuth Client ID.');
      initializeGapiClient();
      document.getElementById('config-section').classList.add('hidden');
      document.getElementById('auth-section').classList.remove('hidden');
    };

    function initializeGapiClient() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          discoveryDocs: [API_DISCOVERY_DOC],
          clientId: CLIENT_ID,
          scope: SCOPES
        }).then(() => {
          GoogleAuth = gapi.auth2.getAuthInstance();
          GoogleAuth.isSignedIn.listen(updateSigninStatus);
          document.getElementById('signin-btn').onclick = () => GoogleAuth.signIn({prompt: 'select_account'});
          document.getElementById('signout-btn').onclick = () => GoogleAuth.signOut();
          updateSigninStatus(GoogleAuth.isSignedIn.get());
        }).catch(err => {
          console.error('Error initializing gapi client:', err);
          alert('Could not initialize Google API. Check console for details.');
        });
      });
    }

    function updateSigninStatus(isSignedIn) {
      document.getElementById('signin-btn').classList.toggle('hidden', isSignedIn);
      document.getElementById('signout-btn').classList.toggle('hidden', !isSignedIn);
      document.getElementById('auth-info').classList.toggle('hidden', !isSignedIn);
      document.getElementById('app-section').classList.toggle('hidden', !isSignedIn);
      document.getElementById('reviews').classList.add('hidden');
      if (isSignedIn) {
        const profile = GoogleAuth.currentUser.get().getBasicProfile();
        document.getElementById('auth-info').textContent = `Signed in as ${profile.getEmail()}`;
      }
    }

    document.getElementById('fetchBtn').onclick = async () => {
      const pkg = document.getElementById('pkg').value.trim();
      if (!pkg) return alert('Enter a package name.');
      const reviewsContainer = document.getElementById('reviews');
      reviewsContainer.textContent = 'Loading reviews...';
      reviewsContainer.classList.remove('hidden');
      try {
        const resp = await gapi.client.androidpublisher.reviews.list({packageName: pkg});
        const reviews = resp.result.reviews || [];
        reviewsContainer.innerHTML = reviews.map(r => {
          const c = r.comments[0].userComment;
          return `<div class="review">
            <strong>${c.authorName}</strong> (Rating: ${c.starRating})<br>
            ${c.text}
            <div><textarea rows="2" cols="60" placeholder="Your reply..."></textarea><br>
            <button data-id="${r.reviewId}" class="reply-btn">Reply</button></div>
          </div>`;
        }).join('');
        document.querySelectorAll('.reply-btn').forEach(btn => {
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id');
            const replyText = btn.previousElementSibling.value.trim();
            if (!replyText) return alert('Enter a reply.');
            try {
              await gapi.client.androidpublisher.reviews.reply({
                packageName: pkg,
                reviewId: id,
                resource: {replyText}
              });
              alert('Replied to ' + id);
            } catch (e) {
              alert('Reply failed: ' + e.result.error.message);
            }
          };
        });
      } catch (e) {
        reviewsContainer.textContent = 'Error: ' + (e.result ? e.result.error.message : e.message);
      }
    };
  </script>
</body>
</html>
