<!--
  GCP CREDENTIALS & ONBOARDING GUIDE:

  1. Google Cloud Console → APIs & Services → OAuth consent screen
     - Under "Test users", add your Google account email(s).
     - Save and wait a few minutes for propagation.
  2. Under "Authorized domains", add:
     • http://localhost:8000
     • https://your-vercel-domain.vercel.app
  3. APIs & Services → Credentials
     - Edit your OAuth client ID (Web application).
     - Add Authorized JavaScript origins and redirect URIs as needed.
     - Save changes.
  4. APIs & Services → Library
     - Enable Play Android Developer API & Identity Services API.
  5. OAuth Consent Screen
     - Publish App to remove test-user restriction if desired.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="script-src 'self' https://accounts.google.com https://apis.google.com https://www.gstatic.com 'unsafe-inline';">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Play Store Reviews Manager</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    label, input, button { display: block; margin: 8px 0; }
    input, button { padding: 8px; font-size: 1rem; }
    button { cursor: pointer; }
    .reviews-container { margin-top: 20px; max-height: 400px; overflow-y: auto; background: #f9f9f9; padding: 10px; }
    .review { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .log { background: #eef; padding: 8px; margin: 8px 0; font-family: monospace; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Play Store Reviews Manager</h2>
  <!-- Log output -->
  <div id="logContainer" class="log"></div>

  <!-- Configuration Section -->
  <section id="config">
    <label for="clientId">OAuth Client ID</label>
    <input type="text" id="clientId" placeholder="Enter your Client ID here" style="width: 400px;">
    <button id="init">Initialize</button>
  </section>

  <!-- Authentication Section -->
  <section id="auth" class="hidden">
    <button id="signIn">Sign In & Authorize</button>
    <button id="signOut" class="hidden">Sign Out</button>
    <button id="refreshTokenBtn" class="hidden">Refresh Access Token</button>
    <div id="userInfo" class="hidden"></div>
  </section>

  <!-- Application Section -->
  <section id="app" class="hidden">
    <label for="pkg">App Package Name</label>
    <input type="text" id="pkg" placeholder="com.example.app">
    <button id="fetch">Fetch Reviews</button>
  </section>

  <!-- Reviews Output -->
  <div id="reviews" class="reviews-container hidden"></div>

  <script>
    (function() {
      // Utility log
      const logContainer = document.getElementById('logContainer');
      function log(msg) {
        console.log(msg);
        const el = document.createElement('div'); el.textContent = msg; logContainer.appendChild(el);
      }

      let clientId = '';
      const SCOPES = 'https://www.googleapis.com/auth/androidpublisher';
      let tokenClient;
      let accessToken = '';

      // Cache DOM elements
      const el = {
        config: document.getElementById('config'),
        auth: document.getElementById('auth'),
        app: document.getElementById('app'),
        reviews: document.getElementById('reviews'),
        clientIdInput: document.getElementById('clientId'),
        initBtn: document.getElementById('init'),
        signInBtn: document.getElementById('signIn'),
        signOutBtn: document.getElementById('signOut'),
        refreshBtn: document.getElementById('refreshTokenBtn'),
        userInfo: document.getElementById('userInfo'),
        pkgInput: document.getElementById('pkg'),
        fetchBtn: document.getElementById('fetch')
      };

      // Initialize token client
      el.initBtn.addEventListener('click', () => {
        clientId = el.clientIdInput.value.trim();
        if (!clientId) { log('Init failed: Client ID missing'); return alert('Please enter OAuth Client ID'); }
        log('Initializing GIS Token Client with Client ID: ' + clientId);
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: SCOPES,
          callback: handleTokenResponse
        });
        toggle(el.config, false);
        toggle(el.auth, true);
      });

      // Sign in
      el.signInBtn.addEventListener('click', () => {
        log('Requesting access token with consent prompt');
        tokenClient.requestAccessToken({prompt: 'consent'});
      });

      // Refresh token
      el.refreshBtn.addEventListener('click', () => {
        log('Refreshing access token silently');
        tokenClient.requestAccessToken({prompt: ''});
      });

      // Sign out
      el.signOutBtn.addEventListener('click', () => {
        log('Revoking access token');
        google.accounts.oauth2.revoke(accessToken, () => {
          accessToken = '';
          updateUI(false);
          log('Access token revoked');
        });
      });

      // Handle token response
      function handleTokenResponse(resp) {
        log('Token response: ' + JSON.stringify(resp));
        if (resp.error) {
          log('Token error: ' + resp.error);
          return alert('Error obtaining token: ' + resp.error);
        }
        accessToken = resp.access_token;
        updateUI(true);
        log('Access token obtained');
      }

      // Toggle element visibility
      function toggle(element, show) {
        element.classList.toggle('hidden', !show);
      }

      // Update UI on sign in/out
      function updateUI(signedIn) {
        log('UpdateUI signedIn=' + signedIn);
        toggle(el.signInBtn, !signedIn);
        toggle(el.signOutBtn, signedIn);
        toggle(el.refreshBtn, signedIn);
        toggle(el.userInfo, signedIn);
        toggle(el.app, signedIn);
        el.reviews.classList.add('hidden');
        if (signedIn) {
          el.userInfo.textContent = 'Authorized';
          log('User authorized');
        }
      }

      // Fetch and render reviews
      async function fetchReviews(pkg) {
        el.reviews.textContent = 'Loading...';
        toggle(el.reviews, true);
        try {
          const url = `https://androidpublisher.googleapis.com/androidpublisher/v3/applications/${encodeURIComponent(pkg)}/reviews`;
          log('API: GET ' + url);
          const res = await fetch(url, { headers: { Authorization: 'Bearer ' + accessToken } });
          log('Response status: ' + res.status);
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          log('Reviews count: ' + (data.reviews || []).length);
          renderReviews(data.reviews || []);
        } catch (e) {
          log('Fetch error: ' + e.message);
          el.reviews.textContent = 'Error: ' + e.message;
        }
      }

      // Render reviews list
      function renderReviews(reviews) {
        el.reviews.innerHTML = reviews.map(r => {
          const c = r.comments[0].userComment;
          return `<div class="review"><strong>${c.authorName}</strong> (Rating: ${c.starRating})<br>${c.text}</div>`;
        }).join('');
        log('Rendered reviews');
      }

    })();
  </script>
</body>
</html>
